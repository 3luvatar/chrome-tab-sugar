<!DOCTYPE html>
<!--
/**
 * Copyright (c) 2010 Arnaud Leymet
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * Chrome Tab Sugar <http://github.com/arnaud/chrome-tab-sugar>
 */
-->

<html>
<head>
  <title>Tab Sugar Options</title>
  <link href="css/options.css" media="screen" rel="stylesheet" type="text/css">
  <script src="js/lib/jquery.1.4.2.min.js" type="text/javascript"></script>
  <script src="js/lib/jquery-ui.1.8.2.min.js" type="text/javascript"></script>
  <script src="js/lib/jquery.hotkeys-0.7.9.min.js" type="text/javascript"></script>
</head>
<body id="options">
  <script src="js/ga.js" type="text/javascript"></script>
  <script src="js/activate_hotkey.js" type="text/javascript"></script>
  <script src="js/storage.js" type="text/javascript"></script>
  <script src="js/jquery.tabsugar.utils.js" type="text/javascript"></script>
  <script type="text/javascript">

  track('Options', 'Start', 'The options page has opened');

  // keep a reference of the background page
  var back = chrome.extension.getBackgroundPage();

  // needed for storage.js to work with this page
  function updateUI() {}

  function reloadTabSugar() {
    console.debug('reloadTabSugar');
    back.location.reload();
  }

  // Reinitializes localStorage and the database
  function reinitialize() {
    console.debug('reinitialize');
    if(confirm("All your TabSugar groups and tabs will be reinitialized.\nAre you sure?")) {
      track('Options', 'Reset', 'Reinitialize the extension', true);

      //$("#reinit").attr("disabled", true);

      // remove the shortcut key from the browser action's description
      chrome.browserAction.setTitle({title: "Tab Sugar"});

      // localStorage
      localStorage.clear();
      console.debug('- localStorage cleared!');

      // database
      db.transaction(function (tx) {
        // drop all tables
        tx.executeSql("DROP TABLE groups");
        tx.executeSql("DROP TABLE tabs");
        console.debug('- database cleared!');

        // reload the extension
        reloadTabSugar();

        showMessage("Tab Sugar was reinitialized.");
      });
    } else {
      track('Options', 'Reset', 'Reinitialize the extension', false);
    }
  }

  // Autoresize tabs inside a group
  function autoresize() {
    var checked = $("#autoresize").attr("checked");
    track('Options', 'Autoresize', 'Auto resize feature', checked);
    if(checked) {
      localStorage.feature_autoresize = true;
      showMessage("Feature 'auto rearrange' is now ON.");
    } else {
      localStorage.feature_autoresize = false;
      showMessage("Feature 'auto rearrange' is now OFF.");
    }
  }

  // Activates the debugger
  function traces() {
    var checked = $("#traces").attr("checked");
    track('Options', 'Developer traces', 'Developer traces', checked);
    if(checked) {
      localStorage.debug = true;
      showMessage("Developer traces activated.");
    } else {
      localStorage.debug = false;
      showMessage("Developer traces deactivated.");
    }
  }

  // Activates the tab previews
  function preview() {
    var checked = $("#preview").attr("checked");
    track('Options', 'Tab preview', 'Tab preview feature', checked);
    if(checked) {
      localStorage.feature_tab_preview = true;
      showMessage("Feature 'tab preview' is now ON.");
    } else {
      localStorage.feature_tab_preview = false;
      showMessage("Feature 'tab preview' is now OFF.");
    }
  }

  // Set the shortcut key
  function shortcut() {
    track('Options', 'Shortcut key', 'Define the shortcut key');
    var last_shortcut = localStorage.shortcut_key;
    var ctrl = $("#shortcut_ctrl").attr("checked");
    var shift = $("#shortcut_shift").attr("checked");
    var key = $("#shortcut_key").val();
    var shortcut = "";
    if(ctrl) shortcut = "ctrl+"
    if(shift) shortcut = shortcut + "shift+"
    shortcut = shortcut + key
    localStorage.shortcut_key = shortcut;
    if(last_shortcut!=null) {
      $(document).unbind('keydown', last_shortcut, requestActionOpen);
    }
    $(document).unbind('keydown', shortcut, requestActionOpen);
    $(document).bind('keydown', shortcut, requestActionOpen);
    showMessage("Tab Sugar can now be triggered with '"+shortcut+"'.");
    chrome.browserAction.setTitle({title: "Tab Sugar ("+shortcut+")"});
  }

  // Define the opening behavior
  function opening() {
    //TODO
    // chrome-extension://libokbfffpaopdjmeofdfpmlanaenaje/sugar.html
  }

  function remainingSpace(min, max) {
    if(min == max) return min;
    var content = "";
    var mid = min + Math.round((max - min) / 2);
    for(var i=0; i<mid; i++) {
      content += "m";
    }
    try {
      localStorage.setItem("TEST_REMAINING_SPACE", content);
    } catch(ex) {
      // KO
      console.debug("LIMIT REACHED: (" + i + ")");
      console.debug(ex);
      return remainingSpace(min, mid);
    }
    // OK
    return remainingSpace(mid, max);
  }

  // Updates the 'storage used' UI
  function updateStorageUseMeter() {
    track('Options', 'Storage used', 'Display the local storage usage');
    showMessage("Calculating the remaining storage space&hellip;");
    setTimeout(function() {
      var max = 5242880;
      var remaining = remainingSpace(0, max);
      var used = max - remaining;
      $('#storageuse').attr('max', max).attr('value', used).show();
      $('#storageuse_calculate').hide();
      showMessage("Remaining storage space calculated successfully.");
    }, 500);
  }

  var dev = false;

  // Activate/deactivate the developer mode (advanced configuration)
  function devmode() {
    dev = !dev;
    if(dev) {
      track('Options', 'Advanced configuration', 'Show the advanced configuration');
      // show advanced configuration
      $('.advanced').show('blind', 'fast');
      $('#devmode').addClass('activated');
    } else {
      // hide advanced configuration
      $('.advanced').hide('blind', 'fast');
      $('#devmode').removeClass('activated');
    }
  }

  function showMessage(message) {
    $('#message').hide().html(message+' <a href="#" onclick="hideMessage()">[x]</a>').show('drop');
  }

  function hideMessage() {
    $('#message').hide('drop');
  }

  $(function() {
    $('.advanced').hide();
    $('#autoresize').attr('checked', localStorage.feature_autoresize=="true");
    $('#preview').attr('checked', localStorage.feature_tab_preview=="true");
    $('#traces').attr('checked', localStorage.debug=="true");
    for(var i=0; i<26; i++) {
      var key = String.fromCharCode(65+i);
      $('#shortcut_key').append('<option value="'+key+'">'+key+'</option>');
    }
    $('#shortcut_ctrl').attr('checked', localStorage.shortcut_key.match('ctrl+'));
    $('#shortcut_shift').attr('checked', localStorage.shortcut_key.match('shift+'));
    var key = localStorage.shortcut_key.replace('ctrl+','').replace('shift+','');
    $("#shortcut_key option[value='"+key+"']").attr('selected', 'selected');
    $('#shortcut_key').attr('checked', localStorage.shortcut_key.length>0);

    // disable right-click contextual menu
    $.disableContextMenu();
  });
  </script>
  <header>
    <img src="/ico/48.png" />
    <h1>Tab Sugar Options</h1>
    <span id="message" style="display: none"></span>
  </header>
  <div id="content">
    <a id="devmode" href="#" onclick="devmode()">Developer mode</a>
    <h2>Options</h2>
    <div class="dev advanced">
      Developer mode:
      <input type="button" id="reinit" href="#" onclick="reinitialize()" value="Reset Tab Sugar&hellip;"></input>
    </div>
    <div id="innercontent">
      <div class="item">
        <label for="preview" class="main">Show tab previews:</label>
        <input type="checkbox" id="preview" onclick="preview()" /><label for="preview">Activate</label>
      </div>
      <div class="item">
        <label for="autoresize" class="main">Auto rearrange group tabs:</label>
        <input type="checkbox" id="autoresize" onclick="autoresize()" /><label for="autoresize">Activate</label>
      </div>
      <div class="item">
        <label class="main">Keyboard shortcut:</label>
        <input type="checkbox" id="shortcut_ctrl" onclick="shortcut()" /><label for="shortcut_ctrl">Ctrl</label>
        +<input type="checkbox" id="shortcut_shift" onclick="shortcut()" /><label for="shortcut_shift">Shift</label>
        +<select id="shortcut_key" onchange="shortcut()">
          <option value="esc">esc</option>
          <option value="space">space</option>
        </select>
        <span class="experimental">(experimental)</span>
      </div>
      <!--
      <label for="opening">Tab Sugar opens:</label>
      <select id="opening" onchange="opening()">
        <option value="new_tab">as a new tab in the current window</option>
        <option value="new_window">as a new window</option>
        <option value="every_new_tab">in every new tab</option>
        <option value="startup">at Chrome startup</option>
      </select>
      -->
      <div class="item advanced">
        <label for="traces" class="main">Developer traces:</label>
        <input type="checkbox" id="traces" onclick="traces()" /><label for="traces">Activate</label>
      </div>
      <div class="item advanced">
        <label for="storageuse" class="main">Data storage use:</label>
        <a id="storageuse_calculate" href="#" onclick="updateStorageUseMeter()">calculate</a>
        <meter id="storageuse" value="0" max="5242880" style="display: none;"></meter>
        <span class="experimental">(experimental)</span>
      </div>
    </div>
  </div>
</body>
</html>
